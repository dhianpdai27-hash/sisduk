<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Segono Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8fafc; color: #1e293b; font-family: 'Inter', sans-serif; }
        .stat-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #1e3a8a; }
        /* Perbesar Font Menu Navigasi */
        .tab-button { font-size: 14px !important; letter-spacing: 0.025em; }
        .tab-button.active { border-bottom: 5px solid #1e3a8a; color: #1e3a8a; font-weight: 900; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 1000; overflow-y: auto; padding: 15px; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; }
        .kk-box { background: white; border: 1px solid #e2e8f0; border-radius: 15px; margin-bottom: 1rem; overflow: hidden; }
        
        /* Input lebih besar agar mudah dibaca */
        input, select { border: 2px solid #cbd5e1; border-radius: 12px; padding: 12px; width: 100%; font-size: 1rem; outline: none; margin-bottom: 8px; color: #1e293b; }
        input:focus { border-color: #1e3a8a; }
        
        /* Label lebih tegas */
        .label-text { display: block; font-size: 0.85rem; font-weight: 800; color: #334155; margin: 8px 0 4px 4px; text-transform: uppercase; }
        
        .list-item-stat { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #e2e8f0; font-size: 1rem; }
        .hidden-module { display: none; }
        @media print { nav, .no-print, button, header { display: none !important; } .container { width: 100% !important; padding: 0 !important; } .stat-card { border: 1px solid #ccc !important; box-shadow: none !important; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm mx-4 text-center mt-20">
            <h2 class="text-2xl font-black mb-6 uppercase text-blue-900">Admin Login</h2>
            <input type="password" id="input-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="mb-4 text-center text-4xl border-2 p-5 rounded-2xl w-full text-blue-900 font-black">
            <button onclick="handleLogin()" class="w-full bg-blue-800 text-white py-5 rounded-2xl font-black shadow-lg text-xl">MASUK</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header class="bg-blue-900 text-white px-6 py-10 shadow-xl text-center no-print">
            <h1 class="text-3xl font-black uppercase tracking-tighter" id="head-dusun">Dusun Segono</h1>
            <p class="text-xs opacity-90 mt-2 font-medium" id="head-alamat">Memuat Alamat...</p>
        </header>

        <nav class="bg-white shadow-md flex justify-around sticky top-0 z-50 no-print border-b-2">
            <button class="tab-button active py-6 px-4 font-black uppercase" data-tab="dashboard">BERANDA</button>
            <button class="tab-button py-6 px-4 font-black uppercase" data-tab="penduduk">WARGA</button>
            <button class="tab-button py-6 px-4 font-black uppercase" data-tab="pengaturan">PANEL</button>
        </nav>

        <main class="container mx-auto p-4 pb-24">
            
            <div id="tab-dashboard" class="tab-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stat-card p-6"><p class="text-[10px] font-black text-gray-500 uppercase mb-1">Warga Aktif</p><h3 id="st-total" class="text-4xl font-black text-blue-900">0</h3></div>
                    <div class="stat-card p-6" style="border-left-color: #f97316;"><p class="text-[10px] font-black text-gray-500 uppercase mb-1">Total KK</p><h3 id="st-kk" class="text-4xl font-black text-orange-600">0</h3></div>
                    <div class="stat-card p-6" style="border-left-color: #10b981;"><p class="text-[10px] font-black text-gray-500 uppercase mb-1">Laki-Laki</p><h3 id="st-laki" class="text-4xl font-black text-emerald-600">0</h3></div>
                    <div class="stat-card p-6" style="border-left-color: #f43f5e;"><p class="text-[10px] font-black text-gray-500 uppercase mb-1">Perempuan</p><h3 id="st-perempuan" class="text-4xl font-black text-rose-600">0</h3></div>
                </div>

                <div id="box-mutasi" class="bg-white p-6 rounded-2xl shadow-sm border mb-6">
                    <div class="flex justify-between items-center mb-4 border-b-2 pb-3">
                        <h2 class="text-blue-900 font-black text-xs uppercase">Laporan Mutasi Bulan Ini</h2>
                        <button onclick="window.print()" class="text-xs font-black text-blue-700 bg-blue-100 px-4 py-2 rounded-lg no-print">PRINT DATA</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div><p class="text-[10px] font-black text-blue-500 uppercase">Lahir</p><span id="mu-lahir" class="text-2xl font-black">0</span></div>
                        <div class="border-x-2"><p class="text-[10px] font-black text-rose-500 uppercase">Mati</p><span id="mu-mati" class="text-2xl font-black">0</span></div>
                        <div><p class="text-[10px] font-black text-orange-500 uppercase">Pindah</p><span id="mu-pindah" class="text-2xl font-black">0</span></div>
                    </div>
                </div>

                <div id="box-pendidikan" class="bg-white p-6 rounded-2xl shadow-sm border mb-4 hidden-module">
                    <h2 class="text-blue-900 font-black text-xs uppercase mb-4 border-b-2 pb-2">Data Pendidikan</h2>
                    <div id="list-edu" class="space-y-1"></div>
                </div>
                <div id="box-pekerjaan" class="bg-white p-6 rounded-2xl shadow-sm border mb-4 hidden-module">
                    <h2 class="text-emerald-700 font-black text-xs uppercase mb-4 border-b-2 pb-2">Data Pekerjaan</h2>
                    <div id="list-job" class="space-y-1"></div>
                </div>
                <div id="box-usia" class="bg-white p-6 rounded-2xl shadow-sm border mb-4 hidden-module">
                    <h2 class="text-orange-700 font-black text-xs uppercase mb-4 border-b-2 pb-2">Kelompok Usia</h2>
                    <div id="list-usia" class="space-y-1"></div>
                </div>
                <div id="box-agama" class="bg-white p-6 rounded-2xl shadow-sm border mb-4 hidden-module">
                    <h2 class="text-purple-700 font-black text-xs uppercase mb-4 border-b-2 pb-2">Data Agama</h2>
                    <div id="list-agama" class="space-y-1"></div>
                </div>
                <div id="box-goldarah" class="bg-white p-6 rounded-2xl shadow-sm border mb-4 hidden-module">
                    <h2 class="text-red-700 font-black text-xs uppercase mb-4 border-b-2 pb-2">Golongan Darah</h2>
                    <div id="list-goldarah" class="space-y-1"></div>
                </div>

                <button onclick="openForm()" class="w-full bg-blue-800 text-white py-6 rounded-2xl font-black shadow-xl uppercase text-lg no-print mt-4">+ Tambah Warga Baru</button>
            </div>

            <div id="tab-penduduk" class="tab-content hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm mb-6 no-print border-2">
                    <label class="label-text">Pencarian Cepat</label>
                    <input type="text" id="cari" placeholder="Ketik Nama / NIK / No. KK..." onkeyup="render()" class="mb-4">
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Filter RT</label>
                            <input type="text" id="filter-rt" placeholder="RT" onkeyup="render()">
                        </div>
                        <div>
                            <label class="label-text">Filter RW</label>
                            <input type="text" id="filter-rw" placeholder="RW" onkeyup="render()">
                        </div>
                    </div>
                </div>
                <div id="list-kk"></div>
            </div>

            <div id="tab-pengaturan" class="tab-content hidden">
                <div class="bg-white p-6 rounded-2xl border-2 mb-6 no-print">
                    <h2 class="font-black mb-5 text-blue-900 uppercase text-sm border-b-2 pb-2">Identitas Wilayah</h2>
                    <div class="grid grid-cols-1 gap-1">
                        <label class="label-text">Nama Dusun</label><input type="text" id="set-dusun">
                        <label class="label-text">Nama Desa</label><input type="text" id="set-desa">
                        <label class="label-text">Kecamatan</label><input type="text" id="set-kec">
                        <label class="label-text">Kabupaten</label><input type="text" id="set-kab">
                        <label class="label-text">Provinsi</label><input type="text" id="set-prov">
                        <label class="label-text">Password Admin (Baru)</label><input type="text" id="set-pass">
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-blue-800 text-white py-5 rounded-xl font-black uppercase text-sm mt-6 shadow-md">Simpan Perubahan</button>
                </div>

                <div class="bg-white p-6 rounded-2xl border-2 mb-6 no-print">
                    <h2 class="font-black mb-5 text-blue-900 uppercase text-sm border-b-2 pb-2">Pilihan Tampilan Dashboard</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <label class="flex items-center gap-4 text-sm font-black uppercase cursor-pointer bg-gray-50 p-4 rounded-xl">
                            <input type="checkbox" id="f-edu" onchange="toggleView()" class="w-6 h-6"> Pendidikan
                        </label>
                        <label class="flex items-center gap-4 text-sm font-black uppercase cursor-pointer bg-gray-50 p-4 rounded-xl">
                            <input type="checkbox" id="f-job" onchange="toggleView()" class="w-6 h-6"> Pekerjaan
                        </label>
                        <label class="flex items-center gap-4 text-sm font-black uppercase cursor-pointer bg-gray-50 p-4 rounded-xl">
                            <input type="checkbox" id="f-usia" onchange="toggleView()" class="w-6 h-6"> Usia
                        </label>
                        <label class="flex items-center gap-4 text-sm font-black uppercase cursor-pointer bg-gray-50 p-4 rounded-xl">
                            <input type="checkbox" id="f-agama" onchange="toggleView()" class="w-6 h-6"> Agama
                        </label>
                        <label class="flex items-center gap-4 text-sm font-black uppercase cursor-pointer bg-gray-50 p-4 rounded-xl">
                            <input type="checkbox" id="f-goldarah" onchange="toggleView()" class="w-6 h-6"> Golongan Darah
                        </label>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border-2 no-print space-y-4">
                    <h2 class="font-black text-blue-900 uppercase text-sm mb-2 border-b-2 pb-2">Kelola Database (Excel)</h2>
                    <button onclick="exportExcel()" class="w-full bg-emerald-700 text-white py-5 rounded-xl font-black uppercase text-sm shadow-md">Export Ke Excel</button>
                    <button onclick="document.getElementById('importFile').click()" class="w-full bg-amber-600 text-white py-5 rounded-xl font-black uppercase text-sm shadow-md">Import Dari Excel</button>
                    <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="importExcel(event)">
                    <button onclick="resetDB()" class="w-full bg-rose-50 text-rose-600 py-5 rounded-xl font-black uppercase text-sm border-2 border-rose-200">Reset Seluruh Data</button>
                </div>
            </div>
        </main>

        <div id="modal-form" class="modal no-print">
            <div class="bg-white w-full max-w-4xl rounded-3xl overflow-hidden shadow-2xl my-4">
                <div class="bg-blue-800 p-6 text-white flex justify-between items-center">
                    <h2 id="modal-title" class="font-black uppercase text-sm tracking-wider">Biodata Penduduk</h2>
                    <button onclick="closeForm()" class="text-4xl font-bold">&times;</button>
                </div>
                <form id="form-data" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 overflow-y-auto max-h-[85vh]">
                    <input type="hidden" name="id" id="form-id">
                    <div class="md:col-span-2 text-blue-800 font-black text-xs border-b-4 border-blue-50 pb-2 mb-4 uppercase">I. Informasi Kartu Keluarga</div>
                    <div><label class="label-text">Nomor KK</label><input type="text" name="noKK" required></div>
                    <div><label class="label-text">Kepala Keluarga</label><input type="text" name="namaKepala" required></div>
                    <div class="md:col-span-2"><label class="label-text">Alamat Lengkap</label><input type="text" name="alamat" required></div>
                    <div class="grid grid-cols-2 gap-4 md:col-span-2">
                        <div><label class="label-text">RT</label><input type="text" name="rt" required></div>
                        <div><label class="label-text">RW</label><input type="text" name="rw" required></div>
                    </div>
                    <div class="md:col-span-2 text-blue-800 font-black text-xs border-b-4 border-blue-50 pb-2 mt-6 mb-4 uppercase">II. Biodata Perorangan</div>
                    <div><label class="label-text">NIK (Sesuai KTP)</label><input type="text" name="nik" required></div>
                    <div><label class="label-text">Nama Lengkap</label><input type="text" name="nama" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label-text">Jenis Kelamin</label><select name="jk" class="h-[52px]"><option value="L">Laki-Laki</option><option value="P">Perempuan</option></select></div>
                        <div><label class="label-text">Hubungan Kel.</label><input type="text" name="hubungan"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label-text">Tempat Lahir</label><input type="text" name="tempatLahir"></div>
                        <div><label class="label-text">Tanggal Lahir</label><input type="date" name="tglLahir" class="h-[52px]"></div>
                    </div>
                    <div><label class="label-text">Agama</label><select name="agama" class="h-[52px]"><option>Islam</option><option>Kristen</option><option>Katolik</option><option>Hindu</option><option>Budha</option><option>Lainnya</option></select></div>
                    <div><label class="label-text">Status Kawin</label><select name="statusKawin" class="h-[52px]"><option>Belum Kawin</option><option>Kawin</option><option>Cerai Hidup</option><option>Cerai Mati</option></select></div>
                    <div><label class="label-text">Pendidikan</label><input type="text" name="pendidikan"></div>
                    <div><label class="label-text">Pekerjaan</label><input type="text" name="pekerjaan"></div>
                    <div><label class="label-text">Gol. Darah</label><input type="text" name="goldarah" placeholder="-"></div>
                    <div><label class="label-text">Kondisi Warga</label><select name="status" class="h-[52px]"><option value="HIDUP">HIDUP</option><option value="LAHIR">LAHIR</option><option value="MENINGGAL">MENINGGAL</option><option value="PINDAH">PINDAH</option></select></div>
                    <div class="grid grid-cols-2 gap-4 md:col-span-2">
                        <div><label class="label-text">Nama Ayah</label><input type="text" name="ayah"></div>
                        <div><label class="label-text">Nama Ibu</label><input type="text" name="ibu"></div>
                    </div>
                    <input type="hidden" name="tglUpdate" id="tglUpdate">
                    <button type="submit" class="md:col-span-2 w-full bg-blue-800 text-white py-6 rounded-2xl font-black uppercase shadow-xl mt-8 text-lg">Simpan Data</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Logika JavaScript tetap sama seperti versi asli Anda agar fitur tidak berubah
        let db = JSON.parse(localStorage.getItem('segono_db')) || [];
        let config = JSON.parse(localStorage.getItem('segono_cfg')) || { pass: "1234", dusun: "Segono", desa: "Desa", kec:"Kecamatan", kab:"Kabupaten", prov: "Provinsi", show: ["f-edu"] };

        function handleLogin() {
            if(document.getElementById('input-pass').value === config.pass) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                init();
            } else { Swal.fire('Error', 'Password Salah!', 'error'); }
        }

        function init() {
            document.getElementById('set-pass').value = config.pass;
            document.getElementById('set-dusun').value = config.dusun;
            document.getElementById('set-desa').value = config.desa;
            document.getElementById('set-kec').value = config.kec;
            document.getElementById('set-kab').value = config.kab;
            document.getElementById('set-prov').value = config.prov || "Provinsi";
            (config.show || []).forEach(id => { if(document.getElementById(id)) document.getElementById(id).checked = true; });
            refreshUI(); toggleView(); render();
        }

        function refreshUI() {
            document.getElementById('head-dusun').innerText = "Dusun " + config.dusun;
            document.getElementById('head-alamat').innerText = `Desa ${config.desa}, Kec. ${config.kec}, Kab. ${config.kab}, ${config.prov}`;
        }

        function saveSettings() {
            config.pass = document.getElementById('set-pass').value;
            config.dusun = document.getElementById('set-dusun').value;
            config.desa = document.getElementById('set-desa').value;
            config.kec = document.getElementById('set-kec').value;
            config.kab = document.getElementById('set-kab').value;
            config.prov = document.getElementById('set-prov').value;
            localStorage.setItem('segono_cfg', JSON.stringify(config));
            refreshUI(); Swal.fire('Berhasil', 'Identitas Disimpan', 'success');
        }

        function toggleView() {
            const boxes = { "f-edu": "box-pendidikan", "f-job": "box-pekerjaan", "f-usia": "box-usia", "f-agama": "box-agama", "f-goldarah": "box-goldarah" };
            const active = [];
            for (let id in boxes) {
                if(document.getElementById(id).checked) { 
                    document.getElementById(boxes[id]).classList.remove('hidden-module'); active.push(id); 
                } else { 
                    document.getElementById(boxes[id]).classList.add('hidden-module'); 
                }
            }
            config.show = active;
            localStorage.setItem('segono_cfg', JSON.stringify(config));
        }

        document.getElementById('form-data').onsubmit = function(e) {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(e.target));
            const now = new Date().toISOString().split('T')[0];
            if(formData.id) {
                const idx = db.findIndex(x => x.id == formData.id);
                db[idx] = {...db[idx], ...formData, tglUpdate: now};
            } else {
                formData.id = Date.now();
                formData.tglUpdate = now;
                db.push(formData);
            }
            localStorage.setItem('segono_db', JSON.stringify(db));
            render(); closeForm(); Swal.fire('Tersimpan!', '', 'success');
        };

        function render() {
            const q = document.getElementById('cari').value.toLowerCase();
            const rt = document.getElementById('filter-rt').value;
            const rw = document.getElementById('filter-rw').value;
            const curMonth = new Date().toISOString().split('-').slice(0,2).join('-');

            const aktif = db.filter(x => x.status === 'HIDUP' || x.status === 'LAHIR');
            document.getElementById('st-total').innerText = aktif.length;
            document.getElementById('st-laki').innerText = aktif.filter(x => x.jk === 'L').length;
            document.getElementById('st-perempuan').innerText = aktif.filter(x => x.jk === 'P').length;

            const mutasi = db.filter(x => (x.tglUpdate || "").startsWith(curMonth));
            document.getElementById('mu-lahir').innerText = mutasi.filter(x => x.status === 'LAHIR').length;
            document.getElementById('mu-mati').innerText = mutasi.filter(x => x.status === 'MENINGGAL').length;
            document.getElementById('mu-pindah').innerText = mutasi.filter(x => x.status === 'PINDAH').length;

            const edu = {}; const job = {}; const agm = {}; const bld = {}; let uBalita=0, uAnak=0, uProd=0, uLansia=0;
            const nowY = new Date().getFullYear();
            
            aktif.forEach(x => {
                let e = (x.pendidikan || "TIDAK ADA").toUpperCase();
                let j = (x.pekerjaan || "TIDAK ADA").toUpperCase();
                let a = (x.agama || "TIDAK ADA").toUpperCase();
                let b = (x.goldarah || "-").toUpperCase();
                edu[e] = (edu[e] || 0) + 1; job[j] = (job[j] || 0) + 1; agm[a] = (agm[a] || 0) + 1; bld[b] = (bld[b] || 0) + 1;
                if(x.tglLahir) {
                    const usia = nowY - new Date(x.tglLahir).getFullYear();
                    if(usia <= 5) uBalita++; else if(usia <= 17) uAnak++; else if(usia <= 55) uProd++; else uLansia++;
                }
            });
            
            document.getElementById('list-edu').innerHTML = Object.keys(edu).map(k => `<div class="list-item-stat"><span>${k}</span><b>${edu[k]}</b></div>`).join('');
            document.getElementById('list-job').innerHTML = Object.keys(job).map(k => `<div class="list-item-stat"><span>${k}</span><b>${job[k]}</b></div>`).join('');
            document.getElementById('list-agama').innerHTML = Object.keys(agm).map(k => `<div class="list-item-stat"><span>${k}</span><b>${agm[k]}</b></div>`).join('');
            document.getElementById('list-goldarah').innerHTML = Object.keys(bld).map(k => `<div class="list-item-stat"><span>${k}</span><b>${bld[k]}</b></div>`).join('');
            document.getElementById('list-usia').innerHTML = `<div class="list-item-stat"><span>Balita</span><b>${uBalita}</b></div><div class="list-item-stat"><span>Anak/Remaja</span><b>${uAnak}</b></div><div class="list-item-stat"><span>Produktif</span><b>${uProd}</b></div><div class="list-item-stat"><span>Lansia</span><b>${uLansia}</b></div>`;

            const filtered = aktif.filter(x => {
                const mQ = (x.nama||"").toLowerCase().includes(q) || (x.nik||"").includes(q) || (x.noKK||"").includes(q);
                const mRT = rt ? x.rt == rt : true; const mRW = rw ? x.rw == rw : true;
                return mQ && mRT && mRW;
            });

            const groups = {}; filtered.forEach(p => { if(!groups[p.noKK]) groups[p.noKK] = []; groups[p.noKK].push(p); });
            document.getElementById('st-kk').innerText = Object.keys(groups).length;

            const list = document.getElementById('list-kk');
            list.innerHTML = '';
            for(let kk in groups) {
                const h = groups[kk][0];
                list.innerHTML += `<div class="kk-box shadow-sm border-2">
                    <div class="bg-blue-50 p-5 border-b-2 flex justify-between items-center text-xs font-black uppercase text-blue-900">
                        <span>üè† ${h.namaKepala} (RT ${h.rt}/RW ${h.rw})</span>
                        <button onclick="editWarga('${h.id}')" class="text-blue-600 no-print font-black">EDIT KK</button>
                    </div>
                    <div class="p-1">${groups[kk].map(m => `<div class="flex justify-between items-center p-4 border-b last:border-0 text-sm">
                        <span><b class="text-base">${m.nama}</b> <br> <small class="text-gray-500 font-bold uppercase text-[10px]">${m.hubungan}</small></span>
                        <div class="flex gap-6 no-print">
                            <button onclick="editWarga('${m.id}')" class="text-blue-500 font-bold text-xl">‚úèÔ∏è</button>
                            <button onclick="mutasiIndividu('${m.id}')" class="text-gray-400 font-bold text-xl">‚öôÔ∏è</button>
                        </div>
                    </div>`).join('')}</div>
                </div>`;
            }
        }

        async function mutasiIndividu(id) {
            const { value: s } = await Swal.fire({ title: 'Status Mutasi', input: 'select', inputOptions: { 'HIDUP':'Tetap Hidup', 'MENINGGAL':'Meninggal Dunia', 'PINDAH':'Pindah Alamat' }, showCancelButton: true });
            if (s) { const i = db.findIndex(x => x.id == id); db[i].status = s; db[i].tglUpdate = new Date().toISOString().split('T')[0]; localStorage.setItem('segono_db', JSON.stringify(db)); render(); }
        }

        function editWarga(id) {
            const data = db.find(x => x.id == id);
            if(data) {
                const form = document.getElementById('form-data');
                for (let key in data) { if(form.elements[key]) form.elements[key].value = data[key]; }
                document.getElementById('modal-title').innerText = "Edit Data Penduduk";
                document.getElementById('modal-form').classList.add('active');
            }
        }

        function openForm() { document.getElementById('modal-title').innerText = "Tambah Warga Baru"; document.getElementById('form-id').value = ""; document.getElementById('modal-form').classList.add('active'); }
        function closeForm() { document.getElementById('modal-form').classList.remove('active'); document.getElementById('form-data').reset(); }
        
        function exportExcel() { 
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data_Warga");
            XLSX.writeFile(wb, "Database_Segono.xlsx"); 
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

                    if(jsonData.length > 0) {
                        const processedData = jsonData.map(item => {
                            if(!item.id) item.id = Date.now() + Math.random();
                            if(!item.status) item.status = "HIDUP";
                            return item;
                        });

                        db = processedData;
                        localStorage.setItem('segono_db', JSON.stringify(db));
                        render();
                        Swal.fire('Berhasil!', jsonData.length + ' data warga berhasil dimasukkan.', 'success');
                    } else {
                        Swal.fire('Gagal', 'File Excel kosong atau tidak terbaca.', 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Gagal membaca file. Pastikan formatnya .xlsx atau .xls', 'error');
                }
                event.target.value = ''; 
            };
            reader.readAsArrayBuffer(file);
        }

        function resetDB() {
            Swal.fire({ title: 'Hapus Semua Data?', text: "Tindakan ini tidak bisa dibatalkan!", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus Semua' }).then((result) => {
                if (result.isConfirmed) { db = []; localStorage.setItem('segono_db', JSON.stringify(db)); render(); }
            });
        }
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                render();
            });
        });
    </script>
</body>
</html>
