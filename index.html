<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Segono Official - Edit & Mutasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8fafc; color: #1e293b; font-family: 'Inter', sans-serif; }
        .stat-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #3b82f6; }
        .tab-button.active { border-bottom: 4px solid #1d4ed8; color: #1d4ed8; font-weight: 800; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 1000; overflow-y: auto; padding: 15px; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; }
        .kk-box { background: white; border: 1px solid #e2e8f0; border-radius: 15px; margin-bottom: 1.2rem; overflow: hidden; }
        input, select { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 10px; width: 100%; font-size: 0.9rem; }
        .label-text { display: block; font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .list-item-stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm mx-4 text-center">
            <div class="text-5xl mb-4"></div>
            <h2 class="text-2xl font-black mb-6 uppercase">Admin Login</h2>
            <input type="password" id="input-pass" placeholder="••••" class="mb-4 text-center text-3xl border-2 p-4 rounded-2xl w-full outline-none">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">MASUK SISTEM</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header class="bg-blue-800 text-white px-6 py-8 shadow-xl text-center">
            <h1 class="text-2xl font-black uppercase tracking-tighter" id="head-dusun">Dusun Segono</h1>
            <p class="text-xs opacity-80" id="head-alamat">Memuat data...</p>
        </header>

        <nav class="bg-white shadow-md flex justify-around sticky top-0 z-50">
            <button class="tab-button active py-5 px-4 text-xs font-black uppercase" data-tab="dashboard"> Beranda</button>
            <button class="tab-button py-5 px-4 text-xs font-black uppercase" data-tab="penduduk"> Data Warga</button>
            <button class="tab-button py-5 px-4 text-xs font-black uppercase" data-tab="pengaturan"> Panel</button>
        </nav>

        <main class="container mx-auto p-4 pb-24">
            <div id="tab-dashboard" class="tab-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stat-card p-5 border-l-blue-600"><p class="label-text">Warga Aktif</p><h3 id="st-total" class="text-3xl font-black">0</h3></div>
                    <div class="stat-card p-5 border-l-orange-500"><p class="label-text">Total KK</p><h3 id="st-kk" class="text-3xl font-black">0</h3></div>
                    <div class="stat-card p-5 border-l-emerald-500"><p class="label-text">Laki-Laki</p><h3 id="st-laki" class="text-3xl font-black">0</h3></div>
                    <div class="stat-card p-5 border-l-rose-500"><p class="label-text">Perempuan</p><h3 id="st-perempuan" class="text-3xl font-black">0</h3></div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-red-100 mb-6">
                    <h2 class="text-red-700 font-black text-[10px] uppercase mb-4 tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Laporan Mutasi (Bulan Ini)
                    </h2>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-blue-50 p-3 rounded-xl"><p class="text-[9px] font-bold text-blue-600 uppercase">Lahir</p><h4 id="mu-lahir" class="text-xl font-black">0</h4></div>
                        <div class="bg-gray-100 p-3 rounded-xl"><p class="text-[9px] font-bold text-gray-600 uppercase">Meninggal</p><h4 id="mu-mati" class="text-xl font-black">0</h4></div>
                        <div class="bg-orange-50 p-3 rounded-xl"><p class="text-[9px] font-bold text-orange-600 uppercase">Pindah</p><h4 id="mu-pindah" class="text-xl font-black">0</h4></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
                    <h2 class="text-blue-800 font-black text-xs uppercase mb-4 tracking-widest border-b pb-2"> Rincian Pendidikan & Pekerjaan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><p class="label-text text-blue-600 mb-3">Tingkat Pendidikan</p><div id="stat-list-pendidikan" class="space-y-1"></div></div>
                        <div><p class="label-text text-emerald-600 mb-3">Jenis Pekerjaan</p><div id="stat-list-pekerjaan" class="space-y-1"></div></div>
                    </div>
                </div>

                <button onclick="openForm()" class="w-full bg-blue-700 text-white py-5 rounded-2xl font-black shadow-xl uppercase text-sm">+ Tambah Warga Baru</button>
            </div>

            <div id="tab-penduduk" class="tab-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-sm border mb-4 grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label class="label-text">Pencarian</label><input type="text" id="cari" placeholder="Nama / NIK..." onkeyup="render()"></div>
                    <div><label class="label-text">RT</label><input type="text" id="filter-rt" placeholder="RT" onkeyup="render()"></div>
                    <div><label class="label-text">RW</label><input type="text" id="filter-rw" placeholder="RW" onkeyup="render()"></div>
                </div>
                <div id="list-kk"></div>
            </div>

            <div id="tab-pengaturan" class="tab-content hidden">
                <div class="bg-white p-6 rounded-2xl border mb-6 shadow-sm">
                    <h2 class="font-black mb-4 text-blue-900 uppercase text-xs">Identitas Wilayah</h2>
                    <div class="space-y-3">
                        <input type="text" id="set-dusun" placeholder="Dusun">
                        <input type="text" id="set-desa" placeholder="Desa">
                        <input type="text" id="set-kec" placeholder="Kecamatan">
                        <input type="text" id="set-kab" placeholder="Kabupaten">
                        <input type="text" id="set-prov" placeholder="Provinsi">
                        <input type="text" id="set-pass" placeholder="Password Admin">
                        <button onclick="saveSettings()" class="w-full bg-blue-800 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Simpan Identitas</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border mb-6 shadow-sm">
                    <h2 class="font-black mb-4 text-green-700 uppercase text-xs">Database Excel</h2>
                    <input type="file" id="import-excel" accept=".xlsx, .xls" class="mb-3 text-xs">
                    <button onclick="importData()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-2 uppercase text-xs">Import Excel</button>
                    <button onclick="exportExcel()" class="w-full bg-slate-700 text-white py-3 rounded-xl font-bold mb-2 uppercase text-xs">Export Semua Data</button>
                    <button onclick="resetDB()" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold uppercase text-xs">Reset Data</button>
                </div>
            </div>
        </main>

        <div id="modal-form" class="modal">
            <div class="bg-white w-full max-w-5xl rounded-[2.5rem] overflow-hidden my-4 shadow-2xl">
                <div class="bg-blue-800 p-6 text-white flex justify-between items-center">
                    <h2 id="modal-title" class="font-black uppercase text-xs tracking-widest">Entri Data Penduduk</h2>
                    <button onclick="closeForm()" class="text-3xl">&times;</button>
                </div>
                <form id="form-data" class="p-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="hidden" name="id" id="form-id">
                    <div class="md:col-span-3 border-b font-black text-[10px] text-blue-700 uppercase">I. Data Kartu Keluarga</div>
                    <input type="text" name="noKK" placeholder="No. KK" required>
                    <input type="text" name="namaKepala" placeholder="Kepala Keluarga" required>
                    <input type="text" name="alamat" placeholder="Alamat">
                    <input type="text" name="rt" placeholder="RT" required>
                    <input type="text" name="rw" placeholder="RW" required>
                    
                    <div class="md:col-span-3 border-b font-black text-[10px] text-blue-700 uppercase mt-4">II. Data Pribadi & Status Mutasi</div>
                    <input type="text" name="nik" placeholder="NIK" required>
                    <input type="text" name="nama" placeholder="Nama Lengkap" required>
                    <select name="jk"><option value="L">Laki-Laki</option><option value="P">Perempuan</option></select>
                    <input type="text" name="tempatLahir" placeholder="Tempat Lahir">
                    <input type="date" name="tglLahir">
                    <select name="status">
                        <option value="HIDUP">STATUS: HIDUP (AKTIF)</option>
                        <option value="LAHIR">STATUS: LAHIR (AKTIF)</option>
                        <option value="MENINGGAL">STATUS: MENINGGAL (ARSIP)</option>
                        <option value="PINDAH">STATUS: PINDAH (ARSIP)</option>
                    </select>
                    <input type="text" name="pendidikan" placeholder="Pendidikan">
                    <input type="text" name="pekerjaan" placeholder="Pekerjaan">
                    <input type="text" name="hubungan" placeholder="Hubungan">
                    <input type="text" name="ayah" placeholder="Ayah">
                    <input type="text" name="ibu" placeholder="Ibu">
                    <input type="hidden" name="tglUpdate" id="tglUpdate">
                    <button type="submit" id="btn-submit" class="md:col-span-3 bg-blue-700 text-white py-5 rounded-2xl font-black uppercase shadow-lg">Simpan Data</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('segono_db')) || [];
        let config = JSON.parse(localStorage.getItem('segono_cfg')) || { pass: "1234", dusun: "Segono", desa: "Segono", kec: "-", kab: "-", prov: "-" };

        function handleLogin() {
            if(document.getElementById('input-pass').value === config.pass) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                init();
            } else { Swal.fire('Error', 'Password Salah!', 'error'); }
        }

        function init() {
            document.getElementById('set-pass').value = config.pass;
            document.getElementById('set-dusun').value = config.dusun;
            document.getElementById('set-desa').value = config.desa;
            document.getElementById('set-kec').value = config.kec;
            document.getElementById('set-kab').value = config.kab;
            document.getElementById('set-prov').value = config.prov;
            refreshUI(); render();
        }

        function saveSettings() {
            config = {
                pass: document.getElementById('set-pass').value,
                dusun: document.getElementById('set-dusun').value,
                desa: document.getElementById('set-desa').value,
                kec: document.getElementById('set-kec').value,
                kab: document.getElementById('set-kab').value,
                prov: document.getElementById('set-prov').value
            };
            localStorage.setItem('segono_cfg', JSON.stringify(config));
            refreshUI(); Swal.fire('Berhasil', 'Pengaturan Disimpan', 'success');
        }

        function refreshUI() {
            document.getElementById('head-dusun').innerText = "Dusun " + config.dusun;
            document.getElementById('head-alamat').innerText = `Desa ${config.desa}, Kec. ${config.kec}, Kab. ${config.kab}, Prov. ${config.prov}`;
        }

        function importData() {
            const f = document.getElementById('import-excel').files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const now = new Date().toISOString().split('T')[0];
                db = [...db, ...json.map(x => ({
                    ...x, 
                    id: x.id || Date.now() + Math.random(), 
                    status: (x.status || 'HIDUP').toUpperCase(),
                    tglUpdate: x.tglUpdate || now
                }))];
                localStorage.setItem('segono_db', JSON.stringify(db));
                render(); Swal.fire('Import Berhasil!', '', 'success');
            };
            reader.readAsArrayBuffer(f);
        }

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                render();
            });
        });

        function openForm() { 
            document.getElementById('modal-title').innerText = "Entri Data Penduduk";
            document.getElementById('form-id').value = "";
            document.getElementById('btn-submit').innerText = "SIMPAN WARGA BARU";
            document.getElementById('modal-form').classList.add('active'); 
        }

        function closeForm() { 
            document.getElementById('modal-form').classList.remove('active'); 
            document.getElementById('form-data').reset(); 
        }

        function editWarga(id) {
            const data = db.find(x => x.id == id);
            if(data) {
                const form = document.getElementById('form-data');
                for (let key in data) {
                    if(form.elements[key]) form.elements[key].value = data[key];
                }
                document.getElementById('modal-title').innerText = "Edit Data: " + data.nama;
                document.getElementById('btn-submit').innerText = "SIMPAN PERUBAHAN";
                document.getElementById('modal-form').classList.add('active');
            }
        }

        document.getElementById('form-data').onsubmit = function(e) {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(e.target));
            const now = new Date().toISOString().split('T')[0];
            
            if(formData.id) {
                // Proses Update
                const idx = db.findIndex(x => x.id == formData.id);
                db[idx] = {...db[idx], ...formData, tglUpdate: now};
            } else {
                // Proses Baru
                formData.id = Date.now();
                formData.tglUpdate = now;
                db.push(formData);
            }
            
            localStorage.setItem('segono_db', JSON.stringify(db));
            render(); closeForm(); 
            Swal.fire('Berhasil!', 'Data telah diperbarui.', 'success');
        };

        function render() {
            const q = document.getElementById('cari').value.toLowerCase();
            const rt = document.getElementById('filter-rt').value;
            const rw = document.getElementById('filter-rw').value;
            const curMonth = new Date().toISOString().split('-').slice(0,2).join('-');

            const aktif = db.filter(x => x.status === 'HIDUP' || x.status === 'LAHIR');
            document.getElementById('st-total').innerText = aktif.length;
            document.getElementById('st-laki').innerText = aktif.filter(x => x.jk === 'L').length;
            document.getElementById('st-perempuan').innerText = aktif.filter(x => x.jk === 'P').length;

            const mutasiBulanIni = db.filter(x => (x.tglUpdate || "").startsWith(curMonth));
            document.getElementById('mu-lahir').innerText = mutasiBulanIni.filter(x => x.status === 'LAHIR').length;
            document.getElementById('mu-mati').innerText = mutasiBulanIni.filter(x => x.status === 'MENINGGAL').length;
            document.getElementById('mu-pindah').innerText = mutasiBulanIni.filter(x => x.status === 'PINDAH').length;

            const eduStat = {}; const jobStat = {};
            aktif.forEach(x => {
                let edu = (x.pendidikan || "TIDAK SEKOLAH").toUpperCase();
                let job = (x.pekerjaan || "TIDAK BEKERJA").toUpperCase();
                eduStat[edu] = (eduStat[edu] || 0) + 1;
                jobStat[job] = (jobStat[job] || 0) + 1;
            });
            document.getElementById('stat-list-pendidikan').innerHTML = Object.keys(eduStat).map(k => `<div class="list-item-stat"><span>${k}</span><span class="font-black">${eduStat[k]}</span></div>`).join('');
            document.getElementById('stat-list-pekerjaan').innerHTML = Object.keys(jobStat).map(k => `<div class="list-item-stat"><span>${k}</span><span class="font-black text-emerald-600">${jobStat[k]}</span></div>`).join('');

            const filtered = aktif.filter(x => {
                const matchQ = (x.nama||"").toLowerCase().includes(q) || (x.nik||"").includes(q);
                const matchRT = rt ? x.rt == rt : true;
                const matchRW = rw ? x.rw == rw : true;
                return matchQ && matchRT && matchRW;
            });

            const groups = {};
            filtered.forEach(p => { if(!groups[p.noKK]) groups[p.noKK] = []; groups[p.noKK].push(p); });
            document.getElementById('st-kk').innerText = Object.keys(groups).length;

            const list = document.getElementById('list-kk');
            list.innerHTML = '';
            for(let kk in groups) {
                const h = groups[kk][0];
                list.innerHTML += `
                    <div class="kk-box">
                        <div class="bg-blue-50 p-4 border-b text-[10px] font-black uppercase flex justify-between items-center">
                            <span> ${h.namaKepala} (RT ${h.rt}/RW ${h.rw})</span>
                            <button onclick="ubahStatusKK('${kk}')" class="text-blue-500 bg-white px-2 py-1 rounded border border-blue-200 text-[8px]">MUTASI 1 KK</button>
                        </div>
                        <div class="p-1">${groups[kk].map(m => `<div class="p-3 border-b text-[10px] flex justify-between items-center">
                            <span class="flex-1"><b>${m.nama}</b> (${m.hubungan})</span> 
                            <div class="flex gap-4">
                                <button onclick="editWarga('${m.id}')" class="text-blue-500 font-bold"> Edit</button>
                                <button onclick="ubahStatusIndividu('${m.id}')" class="text-gray-400"> Mutasi</button>
                            </div>
                        </div>`).join('')}</div>
                    </div>`;
            }
        }

        async function ubahStatusIndividu(id) {
            const { value: status } = await Swal.fire({
                title: 'Ubah Status Warga',
                input: 'select',
                inputOptions: { 'HIDUP': 'Hidup', 'MENINGGAL': 'Meninggal', 'PINDAH': 'Pindah' },
                showCancelButton: true
            });
            if (status) {
                const idx = db.findIndex(x => x.id == id);
                db[idx].status = status;
                db[idx].tglUpdate = new Date().toISOString().split('T')[0];
                localStorage.setItem('segono_db', JSON.stringify(db));
                render();
                Swal.fire('Terarsip', 'Status berhasil diperbarui', 'success');
            }
        }

        async function ubahStatusKK(noKK) {
            const { value: status } = await Swal.fire({
                title: 'Mutasi Satu Keluarga',
                input: 'select',
                inputOptions: { 'PINDAH': 'Pindah Domisili', 'MENINGGAL': 'Meninggal (Seluruhnya)' },
                showCancelButton: true
            });
            if (status) {
                db.forEach((x, idx) => {
                    if(x.noKK === noKK) {
                        db[idx].status = status;
                        db[idx].tglUpdate = new Date().toISOString().split('T')[0];
                    }
                });
                localStorage.setItem('segono_db', JSON.stringify(db));
                render();
                Swal.fire('Berhasil', 'Seluruh keluarga telah dimutasi', 'success');
            }
        }

        function resetDB() { if(confirm('Hapus selamanya?')) { db = []; localStorage.setItem('segono_db', JSON.stringify(db)); render(); } }
        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data_Lengkap");
            XLSX.writeFile(wb, `Database_Segono_Lengkap.xlsx`);
        }
    </script>
</body>
</html>
